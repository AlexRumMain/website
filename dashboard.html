<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Личный кабинет — Blush Boys</title>
  <link rel="stylesheet" href="assets/style.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="assets/script.js"></script>
</head>
<body onload="requireAuth() && redirectByRole()">
  <div class="container dashboard">
    <h1 style="text-align:center;margin:40px 0;">Личный кабинет</h1>
    <p style="text-align:center;color:#94a3b8;">Привет, <span id="email"></span> | <a href="#" onclick="logout()">Выйти</a></p>

    <div class="card">
      <h2>Общие задачи</h2>
      <div id="general-tasks"></div>
    </div>

    <div class="card">
      <h2>Мои задачи</h2>
      <div id="my-tasks"></div>
    </div>

    <div class="card" style="text-align:center;background:linear-gradient(135deg,rgba(0,212,255,0.2),rgba(0,170,255,0.1));">
      <h2>Заработано: $<span id="earned">0</span></h2>
      <p>Выполнено задач: <span id="done">0</span></p>
    </div>
  </div>

  <script>
    async function init() {
      document.getElementById('email').textContent = currentUser.email;
      loadTasks();
      calcEarnings();
    }

    async function loadTasks() {
      const { data: tasks } = await supabase.from('tasks').select('*').order('created_at', { ascending: false });
      const general = tasks.filter(t => !t.assigned_to && t.status !== 'completed');
      const mine = tasks.filter(t => t.assigned_to === currentUser.id || t.taken_by === currentUser.id);

      document.getElementById('general-tasks').innerHTML = general.map(renderTask).join('');
      document.getElementById('my-tasks').innerHTML = mine.map(renderTask).join('');
    }

    function renderTask(t) {
      const mine = t.assigned_to === currentUser.id || t.taken_by === currentUser.id;
      return `<div class="task ${t.priority?'priority':''} ${t.status==='completed'?'completed':''}">
        <strong>${t.title}</strong> — $${t.price}
        <p>${t.description||'Без описания'}</p>
        ${!t.assigned_to && t.status==='open' ? '<button class="btn" style="padding:10px 20px;font-size:14px;" onclick="takeTask(\''+t.id+'\')">Взять</button>' : ''}
        ${mine && t.status!=='completed' ? '<button class="btn" style="padding:10px 20px;font-size:14px;background:#10b981;" onclick="completeTask(\''+t.id+'\')">Выполнено</button>' : ''}
        ${t.status==='completed' ? '<span style="color:#10b981;">✓ Выполнена</span>' : ''}
      </div>`;
    }

    window.takeTask = id => supabase.from('tasks').update({status:'in_progress', taken_by: currentUser.id}).eq('id',id).then(loadTasks);
    window.completeTask = id => supabase.from('tasks').update({status:'completed', completed_at: new Date()}).eq('id',id).then(() => { loadTasks(); calcEarnings(); });

    async function calcEarnings() {
      const { data } = await supabase.from('tasks').select('price').eq('status','completed').or(`assigned_to.eq.${currentUser.id},taken_by.eq.${currentUser.id}`);
      const sum = data.reduce((a,b) => a + b.price, 0);
      document.getElementById('earned').textContent = sum;
      document.getElementById('done').textContent = data.length;
    }
  </script>
</body>

</html>
